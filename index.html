<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lunar Mine Sale</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 font-[Inter]">

  <header class="border-b border-slate-800 bg-slate-900/60 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between">
      <h1 class="text-xl font-bold">ðŸŒ™ Lunar Mine Sale</h1>
      <span id="countdown" class="text-indigo-400 text-sm"></span>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-10">

    <section class="bg-slate-900 p-6 rounded-xl border border-slate-800">
      <h2 class="text-lg font-semibold mb-4">Create Offer</h2>
      <form id="offerForm" class="grid md:grid-cols-4 gap-4">
        <input id="playerId" placeholder="Player ID" required class="bg-slate-800 p-2 rounded">
        <select id="oreType" class="bg-slate-800 p-2 rounded"></select>
        <input id="price" type="number" placeholder="Price" class="bg-slate-800 p-2 rounded">
        <button class="bg-indigo-600 rounded">Submit</button>
      </form>
      <p id="hint" class="text-xs text-amber-400 mt-2"></p>
    </section>

    <section>
      <h2 class="text-lg font-semibold mb-4">Offers</h2>
      <div id="offers" class="grid md:grid-cols-2 gap-4"></div>
    </section>
<!--
    <section class="bg-slate-900 p-6 rounded-xl border border-slate-800">
      <h2 class="text-lg font-semibold mb-4">Waitlist</h2>

      <form id="waitForm" class="grid md:grid-cols-3 gap-4">
        <input id="waitPlayer" placeholder="Player ID" required class="bg-slate-800 p-2 rounded">
        <select id="waitOre" class="bg-slate-800 p-2 rounded"></select>
        <button class="bg-emerald-600 rounded">Join</button>
      </form>

      <p id="waitHash" class="text-xs text-emerald-400 mt-2"></p>

       <div id="waitlist" class="grid md:grid-cols-2 gap-4 mt-6"></div>

      <div class="flex gap-2 mt-4">
        <input id="removeHash" placeholder="Your Hash" class="bg-slate-800 p-2 rounded flex-1">
        <button onclick="removeWait()" class="bg-red-600 px-4 rounded">Remove</button>
      </div> -->
    </section>

  </main>

  <footer class="border-t border-slate-800 py-8 text-xs text-slate-400 text-center">
    <p><b>How to Use</b></p>
    <p>If you have a good Lunar Ore offer, submit your Player ID and price.</p>
    <p>Keep friend slots free, accept the buyer, wait ~5 minutes, then remove.</p>
    <p>Use up/down votes to show if a player is active.</p>
    <!-- 
    <p>Use the Waitlist to sell ores and remove yourself using your hash.</p> -->
    <p class="mt-2">Made by <b>@mpguchii</b> on Discord</p>
  </footer>

  <script>
    const oreIcons = {
      MOONSHELL_NORMAL: "https://wsrv.nl/?output=webp&url=https://garrytools.com/assets/img/survivor/4.4.0/UITexture/LabourDay/LabourMain/product_1.png",
      MOONSHELL_FINE: "https://wsrv.nl/?output=webp&url=https://garrytools.com/assets/img/survivor/4.4.0/UITexture/LabourDay/LabourMain/product_2.png",
      MOONSEA_SUPERIOR: "https://wsrv.nl/?output=webp&url=https://garrytools.com/assets/img/survivor/4.4.0/UITexture/LabourDay/LabourMain/product_3.png",
      MOONSEA_EXCELLENT: "https://wsrv.nl/?output=webp&url=https://garrytools.com/assets/img/survivor/4.4.0/UITexture/LabourDay/LabourMain/product_4.png",
      MOONVEIL_EPIC: "https://wsrv.nl/?output=webp&url=https://garrytools.com/assets/img/survivor/4.4.0/UITexture/LabourDay/LabourMain/product_5.png",
      MOONCORE_LEGEND: "https://wsrv.nl/?output=webp&url=https://garrytools.com/assets/img/survivor/4.4.0/UITexture/LabourDay/LabourMain/product_6.png",
    };

    const API = "https://lunarminesale-production.up.railway.app";
    const oreRules = {
      MOONSHELL_NORMAL: { min: 225, max: 250 },
      MOONSHELL_FINE: { min: 225, max: 250 },
      MOONSEA_SUPERIOR: { min: 675, max: 750 },
      MOONSEA_EXCELLENT: { min: 675, max: 750 },
      MOONVEIL_EPIC: { min: 2250, max: 2500 },
      MOONCORE_LEGEND: { min: 6750, max: 7500 },
    };

    Object.keys(oreRules).forEach(o => {
      oreType.innerHTML += `<option value="${o}">${o.replaceAll("_", " ")}</option>`;
      //waitOre.innerHTML += `<option value="${o}">${o.replaceAll("_", " ")}</option>`;
    });

    oreType.onchange = () => {
      const r = oreRules[oreType.value];
      hint.textContent = `Recommended â‰¥ ${r.min} | Max ${r.max}`;
    };

    offerForm.onsubmit = async e => {
      e.preventDefault();
      const r = oreRules[oreType.value];
      if (price.value < r.min || price.value > r.max) return alert("Invalid price");
      await fetch(API + "/offer", {
        method: "POST", headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: playerId.value, oreType: oreType.value, price: +price.value })
      });
      loadOffers();
    };

    /*waitForm.onsubmit = async e => {
      e.preventDefault();
      const r = await fetch(API + "/waitlist", {
        method: "POST", headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: waitPlayer.value, oreType: waitOre.value })
      });
      const j = await r.json();
      waitHash.textContent = "Your hash: " + j.hash;
      loadWait();
    };*/

    async function removeWait() {
      await fetch(API + "/waitlist/remove", {
        method: "POST", headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hash: removeHash.value })
      });
      loadWait();
    }

   async function loadOffers() {
  const r = await fetch(API + "/offers");
  const data = await r.json();

  // Agrupar por oreType
  const grouped = data.reduce((acc, o) => {
    (acc[o.oreType] ||= []).push(o);
    return acc;
  }, {});

  // Ordenar cada grupo por maior preÃ§o
  Object.values(grouped).forEach(g =>
    g.sort((a, b) => b.price - a.price)
  );

  offers.innerHTML = Object.keys(grouped).map((oreType, idx) => {
    const list = grouped[oreType];
    const bestPrice = list[0]?.price;

    return `
      <div class="border border-slate-800 rounded-lg overflow-hidden">

        <!-- HEADER -->
        <button
          onclick="toggleGroup('${oreType}')"
          class="w-full flex items-center gap-3 p-3 bg-slate-900 hover:bg-slate-800 transition text-left"
        >
          <img src="${oreIcons[oreType]}" class="w-7 h-7" />
          <span class="font-semibold text-indigo-400 flex-1">
            ${oreType.replaceAll("_", " ")}
          </span>
          <span class="text-xs text-slate-400">
            ${list.length} offer(s)
          </span>
          <span id="icon-${oreType}">â–¼</span>
        </button>

        <!-- LIST -->
        <div id="group-${oreType}" class="divide-y divide-slate-800">
          ${list.map(o => `
            <div class="
              flex items-center gap-3 px-3 py-2 text-sm
              ${o.price === bestPrice ? 'bg-emerald-600/10 border-l-4 border-emerald-500' : 'bg-slate-900'}
            ">
              <img src="${oreIcons[o.oreType]}" class="w-9 h-9" />

              <div class="flex-1 leading-tight">
                <p class="font-medium">${o.price} coins</p>
                <p class="text-xs text-slate-400">Player ${o.playerId}</p>
              </div>

              <div class="flex flex-col gap-1 text-xs">
                <button
                  onclick="vote(${o.id}, 'up')"
                  class="px-2 rounded bg-emerald-600/20 hover:bg-emerald-600/40">
                  â¬† ${o.upVotes}
                </button>

                <button
                  onclick="vote(${o.id}, 'down')"
                  class="px-2 rounded bg-red-600/20 hover:bg-red-600/40">
                  â¬‡ ${o.downVotes}
                </button>
              </div>
            </div>
          `).join("")}
        </div>

      </div>
    `;
  }).join("");
}


    async function vote(id, type) {
      await fetch(`${API}/offers/${id}/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type })
      });

      loadOffers();
    }

    async function loadWait() {
      const r = await fetch(API + "/waitlist");
      const d = await r.json();
      waitlist.innerHTML = d.map(w => `
        <div class="bg-slate-800 p-3 rounded">
        <b>${w.oreType.replaceAll("_", " ")}</b><br>
        Player: ${w.playerId}
        </div>`).join("");
    }

    function toggleGroup(oreType) {
  const group = document.getElementById(`group-${oreType}`);
  const icon = document.getElementById(`icon-${oreType}`);

  const hidden = group.classList.toggle("hidden");
  icon.textContent = hidden ? "â–¶" : "â–¼";
}
    
    loadOffers(); 
    //loadWait();
  </script>

</body>

</html>




