<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lunar Mine Sale</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 font-[Inter]">

  <header class="border-b border-slate-800 bg-slate-900/60 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between">
      <h1 class="text-xl font-bold">ðŸŒ™ Lunar Mine Sale</h1>
      <span id="countdown" class="text-indigo-400 text-sm"></span>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-10">

    <section class="bg-slate-900 p-6 rounded-xl border border-slate-800">
      <h2 class="text-lg font-semibold mb-4">Create Offer</h2>
      <form id="offerForm" class="grid md:grid-cols-4 gap-4">
        <input id="playerId" placeholder="Player ID" required class="bg-slate-800 p-2 rounded">
        <select id="oreType" class="bg-slate-800 p-2 rounded"></select>
        <input id="price" type="number" placeholder="Price" class="bg-slate-800 p-2 rounded">
        <button class="bg-indigo-600 rounded">Submit</button>
      </form>
      <p id="hint" class="text-xs text-amber-400 mt-2"></p>
    </section>

    <section>
      <h2 class="text-lg font-semibold mb-4">Offers</h2>
      <div id="offers" class="grid md:grid-cols-2 gap-4"></div>
    </section>

    <section class="bg-slate-900 p-6 rounded-xl border border-slate-800">
      <h2 class="text-lg font-semibold mb-4">Waitlist</h2>

      <form id="waitForm" class="grid md:grid-cols-3 gap-4">
        <input id="waitPlayer" placeholder="Player ID" required class="bg-slate-800 p-2 rounded">
        <select id="waitOre" class="bg-slate-800 p-2 rounded"></select>
        <button class="bg-emerald-600 rounded">Join</button>
      </form>

      <p id="waitHash" class="text-xs text-emerald-400 mt-2"></p>

      <div id="waitlist" class="grid md:grid-cols-2 gap-4 mt-6"></div>

      <div class="flex gap-2 mt-4">
        <input id="removeHash" placeholder="Your Hash" class="bg-slate-800 p-2 rounded flex-1">
        <button onclick="removeWait()" class="bg-red-600 px-4 rounded">Remove</button>
      </div>
    </section>

  </main>

  <footer class="border-t border-slate-800 py-8 text-xs text-slate-400 text-center">
    <p><b>How to Use</b></p>
    <p>If you have a good Lunar Ore offer, submit your Player ID and price.</p>
    <p>Keep friend slots free, accept the buyer, wait ~5 minutes, then remove.</p>
    <p>Use up/down votes to show if a player is active.</p>
    <p>Use the Waitlist to sell ores and remove yourself using your hash.</p>
    <p class="mt-2">Made by <b>@mpguchii</b> on Discord</p>
  </footer>

  <script>
    const API = "https://lunarminesale-production.up.railway.app";
    const oreRules = {
      MOONSHELL_NORMAL: { min: 225, max: 250 },
      MOONSHELL_FINE: { min: 225, max: 250 },
      MOONSEA_SUPERIOR: { min: 675, max: 750 },
      MOONSEA_EXCELLENT: { min: 675, max: 750 },
      MOONVEIL_EPIC: { min: 2250, max: 2500 },
      MOONCORE_LEGEND: { min: 6750, max: 7500 },
    };

    Object.keys(oreRules).forEach(o => {
      oreType.innerHTML += `<option value="${o}">${o.replaceAll("_", " ")}</option>`;
      waitOre.innerHTML += `<option value="${o}">${o.replaceAll("_", " ")}</option>`;
    });

    oreType.onchange = () => {
      const r = oreRules[oreType.value];
      hint.textContent = `Recommended â‰¥ ${r.min} | Max ${r.max}`;
    };

    offerForm.onsubmit = async e => {
      e.preventDefault();
      const r = oreRules[oreType.value];
      if (price.value < r.min || price.value > r.max) return alert("Invalid price");
      await fetch(API + "/offer", {
        method: "POST", headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: playerId.value, oreType: oreType.value, price: +price.value })
      });
      loadOffers();
    };

    waitForm.onsubmit = async e => {
      e.preventDefault();
      const r = await fetch(API + "/waitlist", {
        method: "POST", headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerId: waitPlayer.value, oreType: waitOre.value })
      });
      const j = await r.json();
      waitHash.textContent = "Your hash: " + j.hash;
      loadWait();
    };

    async function removeWait() {
      await fetch(API + "/waitlist/remove", {
        method: "POST", headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hash: removeHash.value })
      });
      loadWait();
    }

    async function loadOffers() {
      const r = await fetch(API + "/offers");
      const d = await r.json();

      offers.innerHTML = d.map(o => `
        <div class="bg-slate-900 p-4 rounded border border-slate-800 flex justify-between items-center">
          <div>
            <b>${o.oreType.replaceAll("_", " ")}</b>
            <p class="text-sm text-slate-400">Player: ${o.playerId}</p>
            <p class="text-indigo-400 font-bold">${o.price} coins</p>
          </div>

          <div class="flex flex-col gap-1 text-sm">
            <button
              onclick="vote(${o.id}, 'up')"
              class="bg-emerald-600/20 hover:bg-emerald-600/40 px-2 rounded">
              â¬† ${o.upVotes}
            </button>

            <button
              onclick="vote(${o.id}, 'down')"
              class="bg-red-600/20 hover:bg-red-600/40 px-2 rounded">
              â¬‡ ${o.downVotes}
            </button>
          </div>
        </div>
      `).join("");
    }

    async function vote(id, type) {
      await fetch(`${API}/offers/${id}/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type })
      });

      loadOffers();
    }

    async function loadWait() {
      const r = await fetch(API + "/waitlist");
      const d = await r.json();
      waitlist.innerHTML = d.map(w => `
<div class="bg-slate-800 p-3 rounded">
<b>${w.oreType.replaceAll("_", " ")}</b><br>
Player: ${w.playerId}
</div>`).join("");
    }

    loadOffers(); loadWait();
  </script>

</body>

</html>
